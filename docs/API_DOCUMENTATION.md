# API Documentation

## Base URL
- **Development:** `http://localhost:5000/api`
- **Production:** `https://your-domain.com/api`

---

## Endpoints

### 1. Chat Endpoint

#### Send Message
**POST** `/chat`

Send a user message and get an AI response based on campus data.

**Headers:**
```
Content-Type: application/json
Authorization: Bearer {idToken} (Optional, for rate limiting tracking)
```

**Request Body:**
```json
{
  "message": "What events are happening this week?"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "What events are happening this week?",
  "response": "Based on our campus calendar, here are this week's events...",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "context": ["events", "faqs"]
}
```

**Response (400 Bad Request):**
```json
{
  "error": "Message is required and must be non-empty"
}
```

**Response (429 Too Many Requests):**
```json
{
  "error": "You have reached the maximum number of queries. Please try again later."
}
```

**Rate Limiting:**
- Global: 100 requests per 15 minutes per IP
- Per User: 20 requests per hour per user

**Notes:**
- Authentication token is optional
- Context array shows which collections were used to generate response
- Conversation is stored in Firestore for analytics

---

### 2. Admin Data Endpoints

All admin endpoints require Firebase authentication with admin token.

#### Get Collection Data
**GET** `/admin/data?collection={collectionName}`

Fetch all documents from a collection.

**Headers:**
```
Authorization: Bearer {adminIdToken}
Content-Type: application/json
```

**Query Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| collection | string | Yes | Collection name (events, clubs, faqs, facilities, academic_info) |

**Response (200 OK):**
```json
{
  "success": true,
  "collection": "events",
  "count": 5,
  "data": [
    {
      "id": "event123",
      "title": "Tech Fest",
      "description": "Annual tech festival",
      "date": "2024-03-15",
      "time": "10:00 AM",
      "venue": "Main Auditorium",
      "organizer": "Tech Club",
      "category": "technical",
      "status": "upcoming",
      "createdAt": "2024-01-15T10:30:00.000Z",
      "createdBy": "admin@campus.edu"
    }
  ]
}
```

**Response (403 Forbidden):**
```json
{
  "error": "Admin access required"
}
```

**Response (500 Error):**
```json
{
  "error": "Failed to fetch data"
}
```

---

#### Create Document
**POST** `/admin/data`

Create a new document in a collection.

**Headers:**
```
Authorization: Bearer {adminIdToken}
Content-Type: application/json
```

**Request Body:**
```json
{
  "collection": "events",
  "document": {
    "title": "Web Development Workshop",
    "description": "Learn modern web development",
    "date": "2024-02-20",
    "time": "2:00 PM",
    "venue": "Lab 301",
    "organizer": "Tech Club",
    "category": "technical",
    "status": "upcoming"
  }
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "id": "event_new_id_123",
  "message": "Document created in events"
}
```

**Response (400 Bad Request):**
```json
{
  "error": "Collection and document are required"
}
```

**Notes:**
- `createdAt` and `createdBy` are automatically added
- Document ID is auto-generated by Firestore

---

#### Update Document
**PUT** `/admin/data`

Update an existing document.

**Headers:**
```
Authorization: Bearer {adminIdToken}
Content-Type: application/json
```

**Request Body:**
```json
{
  "collection": "events",
  "id": "event_id_123",
  "document": {
    "status": "completed",
    "title": "Web Development Workshop - COMPLETED"
  }
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Document updated in events"
}
```

**Notes:**
- `updatedAt` and `updatedBy` are automatically added
- Partial updates are supported (only provided fields are updated)

---

#### Delete Document
**DELETE** `/admin/data`

Delete a document from a collection.

**Headers:**
```
Authorization: Bearer {adminIdToken}
Content-Type: application/json
```

**Request Body:**
```json
{
  "collection": "events",
  "id": "event_id_123"
}
```

**Response (200 OK):**
```json
{
  "success": true,
  "message": "Document deleted from events"
}
```

**Response (403 Forbidden):**
```json
{
  "error": "Admin access required"
}
```

---

### 3. Health Check

#### Check Server Status
**GET** `/health`

No authentication required. Used for monitoring.

**Response (200 OK):**
```json
{
  "status": "Server is running",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

---

## Error Handling

### Common Status Codes

| Code | Meaning | Example |
|------|---------|---------|
| 200 | Success | Data retrieved/modified successfully |
| 400 | Bad Request | Missing required fields |
| 401 | Unauthorized | No/invalid authentication token |
| 403 | Forbidden | User doesn't have required permissions |
| 404 | Not Found | Collection or document not found |
| 429 | Rate Limited | Too many requests |
| 500 | Server Error | Unexpected server error |

### Error Response Format

```json
{
  "error": "Error message describing what went wrong",
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

---

## Authentication

### Getting an ID Token

```javascript
import { auth } from 'firebase/auth';
import { signInWithEmailAndPassword } from 'firebase/auth';

// Login
await signInWithEmailAndPassword(auth, email, password);

// Get token
const user = auth.currentUser;
const idToken = await user.getIdToken();

// Use in API calls
const response = await fetch('http://localhost:5000/api/admin/data?collection=events', {
  headers: {
    'Authorization': `Bearer ${idToken}`,
    'Content-Type': 'application/json'
  }
});
```

### Token Refresh

Tokens expire after 1 hour. Firebase automatically refreshes them before expiry.

To force refresh:
```javascript
const newToken = await user.getIdToken(true);
```

---

## Rate Limiting

### Limits

- **Global:** 100 requests per 15 minutes per IP address
- **Per User:** 20 requests per hour (requires authentication)

### Handling Rate Limits

When rate limited, you receive:
```
HTTP 429 Too Many Requests

{
  "error": "You have reached the maximum number of queries. Please try again later.",
  "retryAfter": 3600
}
```

Wait for the `retryAfter` seconds before retrying.

---

## Caching & Performance

### Client-Side Caching

The frontend implements:
- Conversation history (stored in component state)
- Recent queries (not yet implemented, but recommended)

### Server-Side Optimization

The backend implements:
- Context retrieval limits (max 10 documents per collection)
- Keyword extraction to minimize database queries
- Firebase Firestore indexes for common patterns

---

## Example Requests

### Using cURL

```bash
# Send chat message
curl -X POST http://localhost:5000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message":"Tell me about clubs"}'

# Get events (requires admin token)
curl -X GET "http://localhost:5000/api/admin/data?collection=events" \
  -H "Authorization: Bearer YOUR_ID_TOKEN"

# Create event
curl -X POST http://localhost:5000/api/admin/data \
  -H "Authorization: Bearer YOUR_ID_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "collection":"events",
    "document":{
      "title":"New Event",
      "date":"2024-03-01",
      "status":"upcoming"
    }
  }'
```

### Using Postman

1. Set up environment variables:
   - `base_url`: `http://localhost:5000/api`
   - `id_token`: Your Firebase ID token

2. Create requests with:
   - **Method:** GET/POST/PUT/DELETE
   - **URL:** `{{base_url}}/endpoint`
   - **Headers:** 
     ```
     Authorization: Bearer {{id_token}}
     Content-Type: application/json
     ```

---

## Monitoring

### Analytics Stored

Every chat message stores:
- User message
- AI response
- Timestamp
- User ID
- Collections used

Access analytics via Firestore â†’ conversations collection.

### Metrics to Track

1. **Response Quality:** thumbs up/down feedback
2. **Performance:** response time < 3 seconds
3. **Usage:** daily active users, queries per user
4. **Accuracy:** % of correct answers

---

## Future Enhancements

- [ ] Webhook support for external integrations
- [ ] Batch operations for admin uploads
- [ ] Search endpoint across all collections
- [ ] Analytics dashboard API
- [ ] Export/import functionality
- [ ] Feedback endpoint for rating responses
